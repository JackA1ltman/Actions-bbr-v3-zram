name: 构建带有BBRv3的内核

on:
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: 删除旧的工作流运行记录
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 0

  build:
    needs: cleanup
    strategy:
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
          - arch: arm64
            runs_on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs_on }}
    env:
      ARCH: ${{ matrix.arch }}
      KERNEL_VERSION: ""
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "false"
    steps:
      - name: 获取内核版本
        id: get_kernel_version
        run: |
          version=$(curl -s https://www.kernel.org \
            | grep -A1 -m1 "stable:" \
            | grep -oP '\d+\.\d+\.\d+')
          echo "KERNEL_VERSION=$version" >> $GITHUB_ENV

      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装依赖项
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential \
            libncurses-dev libssl-dev libelf-dev \
            bison bc flex rsync debhelper \
            dpkg-dev fakeroot kmod cpio dwarves \
            lz4 zstd xz-utils curl jq ccache

      - name: 创建源码目录
        run: mkdir -p ./kernel/linux

      - name: 下载内核源代码
        working-directory: ./kernel
        run: |
          branch=$(echo "${{ env.KERNEL_VERSION }}" | grep -oP '^\d+\.\d+')
          git clone --depth=1 --branch linux-$branch.y \
            https://github.com/gregkh/linux.git linux

      - name: 添加 Google BBRv3
        working-directory: ./kernel/linux
        run: |
          git remote add google-bbr https://github.com/google/bbr.git
          git fetch google-bbr
          git checkout google-bbr/v3

      - name: 编译声明
        working-directory: ./kernel/linux
        run: |
          grep -v "MODULE_DESCRIPTION" net/ipv4/tcp_bbr.c > net/ipv4/tcp_bbr.c.tmp
          mv net/ipv4/tcp_bbr.c.tmp net/ipv4/tcp_bbr.c
          
          echo 'MODULE_DESCRIPTION("TCP BBR v3 (Bottleneck Bandwidth and RTT) - Compiled & Optimized by Joey");' >> net/ipv4/tcp_bbr.c
          
          tail -n 5 net/ipv4/tcp_bbr.c

      - name: 更新 Makefile 中的版本号
        working-directory: ./kernel/linux
        run: |
          IFS='.' read -r v p s <<< "${{ env.KERNEL_VERSION }}"
          sed -i "s/^VERSION *=.*/VERSION = $v/" Makefile
          sed -i "s/^PATCHLEVEL *=.*/PATCHLEVEL = $p/" Makefile
          sed -i "s/^SUBLEVEL *=.*/SUBLEVEL = $s/" Makefile

      - name: 准备 .config 并禁用证书检查
        working-directory: ./kernel/linux
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            curl -sSL https://raw.githubusercontent.com/JackA1ltman/Actions-bbr-v3-zram/main/arm64.config > .config
          else
            curl -sSL https://raw.githubusercontent.com/JackA1ltman/Actions-bbr-v3-zram/main/x86-64.config > .config
          fi

          scripts/config --disable SYSTEM_TRUSTED_KEYS
          scripts/config --disable SYSTEM_REVOCATION_KEYS
          
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            make ARCH=arm64 olddefconfig
          else
            make olddefconfig
          fi

          echo "BUILD_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: 设定 ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: build-${{ env.BUILD_TIME }}
          max-size: 2G

      - name: 构建内核 Debian 包
        working-directory: ./kernel/linux
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            make ARCH=arm64 CC="ccache gcc" CXX="ccache g++" bindeb-pkg -j$(nproc) LOCALVERSION=-joeyblog-jacka1ltman-bbrv3
          else
            make CC="ccache gcc" CXX="ccache g++" bindeb-pkg -j$(nproc) LOCALVERSION=-joeyblog-jacka1ltman-bbrv3
          fi

      - name: 上传配置文件
        uses: actions/upload-artifact@v4
        with:
          name: config-${{ matrix.arch }}
          path: ./kernel/linux/.config

      - name: 上传 deb 包
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: ./kernel/linux-*.deb

      - name: 发布到 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.arch }}-${{ env.KERNEL_VERSION }}
          files: ./kernel/linux-*.deb
          body: "带有 BBRv3 的最新内核，适用于 ${{ matrix.arch }} 架构。Compiled & Optimized by Joey."
